# Пайплайн препроцессинга данных

Ниже описан единый и воспроизводимый конвейер предобработки томографических исследований грудной клетки, используемый в коде для обучения и инференса. Он покрывает как входы в формате DICOM (папка с .dcm) и NIfTI (`.nii`/`.nii.gz`), так и архивы (`.zip`, `.tar`, `.tgz`, `.tar.gz`).

## Поддерживаемые входы
- DICOM-папка: директория, содержащая файлы `.dcm` одной серии или нескольких серий
- NIfTI: файлы `.nii` или `.nii.gz`
- Архивы: `.zip`, `.tar`, `.tgz`, `.tar.gz` c содержимым из DICOM или NIfTI

## Целевые выходы
- CT_CLIP-путь: тензор `float32` формы `(1, D, H, W)` со значениями в диапазоне `[-1, 1]`, паддинг — значением `-1`

## Общие шаги (DICOM и NIfTI)
1. Если вход — архив, распаковать во временную директорию. Для обучающего пайплайна дополнительно разворачивается вложенная единичная директория (если есть), чтобы получить плоскую структуру.
2. Если вход — DICOM:
   - Найти все доступные серии КТ (модальность CT), отсортировать срезы в серии по `ImagePositionPatient[2]`.
   - Для инференса: валидировать тело исследования — ожидается `CHEST`. Если DICOM-теги неоднозначны, применяется BodyPartReg модель для определения области тела по объёму. Невалидные серии исключаются, формируются предупреждения.
   - Выбрать «лучшую» серию: минимальная толщина среза (`SliceThickness`) с дополнительной фильтрацией по оконным параметрам (`WindowCenter∈[30,50]`, `WindowWidth∈[300,500]`) — если таких несколько, берётся первая подходящая.
   - Скопировать выбранные `.dcm` во временную папку и использовать её как финальный источник данных.
   - Извлечь идентификаторы `StudyInstanceUID` и `SeriesInstanceUID` (используются в логах/метаданных; для инференса добавляются в ответ).
3. Если вход — NIfTI: использовать файл напрямую.

## Нормализация и ресемплинг
- Чтение объёма через TorchIO (`tio.ScalarImage`), преобразование ориентации к `SLP`.
- Приведение к типу `float64` внутри TorchIO-объекта (для корректных геометрических операций).
- `RescaleSlope` и `RescaleIntercept` применяются автоматически на этапе чтения TorchIO.
- Значения Хаунсфилда клипируются в интервал `[-1000, 1000]`.
- Ресемплинг к целевому пространственному разрешению: `spacing_z=1.5 мм`, `spacing_x=0.75 мм`, `spacing_y=0.75 мм` (анизотропная сетка).
- Масштабирование интенсивностей: деление на `1000` для перевода диапазона к `[-1, 1]`.
- Центр-кроп и симметричный паддинг до формы `(H=480, W=480, D=240)`, паддинг заполняется значением `-1`.
- Преобразование к форме тензора `(1, D, H, W)` (`channels-first`: добавляется канал, затем перестановка осей).