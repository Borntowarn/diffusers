# Запуск стека и локальный инференс

Этот раздел охватывает каким образом происходит сборка и запуск инференса для внутреннего тестироваия на 400 КТ.

Чтобы запустить решение без сборки смотрите [гайд по быстрому старту](./quick_start.md#1-быстрый-старт-внутреннего-тестирования-из-заранее-подготовленного-образа)

### 1. Локальный запуск инференса

Для того, чтобы запустить инференс локально, необходимо

1. Подготовить окружение в соответствии с [гайдом](./development.md)
2. Полготовить модели и веса в соответствии с [гайдом](./models.md#3-скачивание-исходных-моделей)
2. Подготовить папку с входными данными (архивами)

Ожидается входная директория с zip-архивами исследований:
```
YOUR_INPUT_FOLDER_WITH_ZIPS/
  study_id_1.zip
  study_id_2.zip
  ...
  final_archive.zip
```

3. Далее перейти в директорию `training`:
```bash
cd training
```
4. Установить путь к входным данным в системную переменную `INPUT_FOLDER`:
```bash
export INPUT_FOLDER="/home/borntowarn/projects/chest-diseases/input"
```
Для **Windows** используйте следующую команду в командной строке :
```bash
set INPUT_FOLDER=C:/Users/ваш_пользователь/projects/chest-diseases/input
```
⚠️ На Windows избегайте пробелов в пути или экранируйте их кавычками.

5. Запустить скрипт инференса:
```bash
python inference.py
```

Это запустит скрипт инференса и сохранит результаты в папку `output`.

### 2. Локальная сборка образа и запуск инференса

1. Подготовить виртуальное окружение в соответствии с [гайдом](./development.md)
2. Полготовить модели и веса в соответствии с [гайдом](./models.md#3-скачивание-исходных-моделей)
3. Подготовить папку с входными данными (архивами)

4. Внутри файла `inference.local.sh` необходимо заменить переменную `YOUR_INPUT_FOLDER_WITH_ZIPS` на абсолютный путь к папке с архивами.

Таким образом ваш скрипт для развертывания решения будет выглядеть следующим образом:
```bash
#!/bin/bash

# Путь к входным данным в папке (рекомендуется указать АБСОЛЮТНЫЙ путь)
# Папка с zip-файлами должна иметь структуру вида:
# YOUR_INPUT_FOLDER_WITH_ZIPS/
#   study_id_1.zip
#   study_id_2.zip
#   ...
#   final_archive.zip

# НАПРИМЕР: YOUR_INPUT_FOLDER_WITH_ZIPS="/home/borntowarn/projects/chest-diseases/input"

# НАПРИМЕР: YOUR_INPUT_FOLDER_WITH_ZIPS="C:/ВАШ/ПУТЬ/К/ПАПКЕ/С/АРХИВАМИ"

# НАПРИМЕР: YOUR_INPUT_FOLDER_WITH_ZIPS="C:\ВАШ\ПУТЬ\К\ПАПКЕ\С\АРХИВАМИ"

###########################################################################
#                                                                         #
#   Будьте внимательны, необходимо передать путь к ПАПКЕ, а не к файлу!   #
#                                                                         #
###########################################################################

YOUR_INPUT_FOLDER_WITH_ZIPS="/home/borntowarn/projects/chest-diseases/input"
YOUR_OUTPUT_FOLDER="/$PWD/output"

docker build -t inference -f ./Dockerfile.inference.yaml .

echo "ВАШ ПУТЬ К ПАПКЕ С АРХИВАМИ: $YOUR_INPUT_FOLDER_WITH_ZIPS"
echo "ВАШ ПУТЬ К ПАПКЕ С РЕЗУЛЬТАТАМИ: $YOUR_OUTPUT_FOLDER"

docker run \
    -it \
    --gpus "all" \
    -e INPUT_FOLDER="./input" \
    -v "$YOUR_INPUT_FOLDER_WITH_ZIPS":/training/input \
    -v "$YOUR_OUTPUT_FOLDER":/training/output \
    inference
```

-  Папки `INPUT_FOLDER="./input"` - внутренняя папка, в которую будут монтироваться входные данные из папки `YOUR_INPUT_FOLDER_WITH_ZIPS`
-  Папка `YOUR_OUTPUT_FOLDER` - папка, в которую будут сохраняться результаты инференса: файлы `output.xlsx` и `warnings_and_errors.txt`. Она автоматически примонтируется в локальной файловой системе и будет доступна.

5. Запустить скрипт инференса:
```bash
sh ./inference.local.sh
```

Это запустит локальную сборку образа, копирование необходимых моделей, весов и скриптов в образ, создание окружения в контейнере и запуск инференса внутри него по примонтированной папке, которая указана в `YOUR_INPUT_FOLDER_WITH_ZIPS`.